@model DFTRK.ViewModels.RetailerProfitabilityAnalysisViewModel

@{
    ViewData["Title"] = "Profitability Analysis";
}

<div class="container">
    <div class="row mb-4">
        <div class="col">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1><i class="bi bi-calculator me-2"></i>Profitability Analysis</h1>
                    <p class="text-muted">Optimize your pricing strategy and maximize profit margins</p>
                </div>
                <a asp-controller="Home" asp-action="RetailerDashboard" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left me-2"></i>Back to Dashboard
                </a>
            </div>
        </div>
    </div>

    <!-- Date Range Filter -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-body">
                    <form asp-action="RetailerProfitabilityAnalysis" method="get" class="row g-3 align-items-end">
                        <div class="col-md-4">
                            <label class="form-label">Start Date</label>
                            <input type="date" name="startDate" class="form-control" value="@Model.StartDate.ToString("yyyy-MM-dd")" />
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">End Date</label>
                            <input type="date" name="endDate" class="form-control" value="@Model.EndDate.ToString("yyyy-MM-dd")" />
                        </div>
                        <div class="col-md-4">
                            <button type="submit" class="btn btn-primary w-100">Apply Filter</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Overall Profitability Summary -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white h-100">
                <div class="card-body">
                    <h5 class="card-title">Total Cost Basis</h5>
                    <div class="d-flex justify-content-between align-items-center">
                        <h2 class="display-4">$@Model.TotalCosts.ToString("N0")</h2>
                        <i class="bi bi-currency-dollar fs-1"></i>
                    </div>
                    <small>Your purchase costs</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white h-100">
                <div class="card-body">
                    <h5 class="card-title">Potential Revenue</h5>
                    <div class="d-flex justify-content-between align-items-center">
                        <h2 class="display-4">$@Model.TotalPotentialRevenue.ToString("N0")</h2>
                        <i class="bi bi-graph-up fs-1"></i>
                    </div>
                    <small>With suggested pricing</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-dark h-100">
                <div class="card-body">
                    <h5 class="card-title">Potential Profit</h5>
                    <div class="d-flex justify-content-between align-items-center">
                        <h2 class="display-4">$@Model.TotalPotentialProfit.ToString("N0")</h2>
                        <i class="bi bi-cash-stack fs-1"></i>
                    </div>
                    <small>Gross profit margin</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white h-100">
                <div class="card-body">
                    <h5 class="card-title">Overall Margin</h5>
                    <div class="d-flex justify-content-between align-items-center">
                        <h2 class="display-4">@Model.OverallMargin.ToString("F1")%</h2>
                        <i class="bi bi-percent fs-1"></i>
                    </div>
                    <small>Profit percentage</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Category Profitability Analysis -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-pie-chart-fill me-2"></i>Category Profitability Analysis</h5>
                </div>
                <div class="card-body">
                    @if (Model.CategoryProfitability.Any())
                    {
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>Category</th>
                                        <th class="text-center">Products</th>
                                        <th class="text-center">Quantity</th>
                                        <th class="text-end">Total Cost</th>
                                        <th class="text-end">Avg Cost/Unit</th>
                                        <th class="text-center">Suggested Markup</th>
                                        <th class="text-end">Potential Revenue</th>
                                        <th class="text-end">Potential Profit</th>
                                        <th class="text-center">Margin %</th>
                                        <th class="text-center">ROI %</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var category in Model.CategoryProfitability)
                                    {
                                        <tr>
                                            <td><strong>@category.Category</strong></td>
                                            <td class="text-center">@category.ProductCount</td>
                                            <td class="text-center">@category.TotalQuantity</td>
                                            <td class="text-end">$@category.TotalCost.ToString("N2")</td>
                                            <td class="text-end">$@category.AvgCostPerUnit.ToString("N2")</td>
                                            <td class="text-center">
                                                <span class="badge bg-primary">@((category.SuggestedMarkup * 100).ToString("F0"))%</span>
                                            </td>
                                            <td class="text-end">$@category.PotentialRevenue.ToString("N2")</td>
                                            <td class="text-end">
                                                <span class="text-success">$@category.PotentialProfit.ToString("N2")</span>
                                            </td>
                                            <td class="text-center">
                                                @{
                                                    var marginColor = category.MarginPercentage >= 35 ? "success" :
                                                                     category.MarginPercentage >= 25 ? "warning" : "danger";
                                                }
                                                <span class="badge bg-@marginColor">@category.MarginPercentage.ToString("F1")%</span>
                                            </td>
                                            <td class="text-center">
                                                @{
                                                    var roiColor = category.ROI >= 50 ? "success" :
                                                                  category.ROI >= 30 ? "warning" : "danger";
                                                }
                                                <span class="badge bg-@roiColor">@category.ROI.ToString("F1")%</span>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <div class="text-center p-4">
                            <p class="text-muted mb-0">No profitability data available for the selected period.</p>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- Profitability Insights -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-graph-up me-2"></i>Visual Profit Distribution</h5>
                </div>
                <div class="card-body">
                    @if (Model.CategoryProfitability.Any())
                    {
                        @foreach (var category in Model.CategoryProfitability.OrderByDescending(c => c.PotentialProfit))
                        {
                            <div class="mb-3">
                                <div class="d-flex justify-content-between align-items-center mb-1">
                                    <span><strong>@category.Category</strong></span>
                                    <span class="text-muted">$@category.PotentialProfit.ToString("N0") profit</span>
                                </div>
                                <div class="progress" style="height: 25px;">
                                    @{
                                        var maxProfit = Model.CategoryProfitability.Max(c => c.PotentialProfit);
                                        var percentage = maxProfit > 0 ? (int)(category.PotentialProfit / maxProfit * 100) : 0;
                                        var barColor = category.MarginPercentage >= 35 ? "success" :
                                                      category.MarginPercentage >= 25 ? "warning" : "danger";
                                    }
                                    <div class="progress-bar bg-@barColor" role="progressbar" 
                                         style="width: @percentage%;" aria-valuenow="@percentage" 
                                         aria-valuemin="0" aria-valuemax="100">
                                        @category.MarginPercentage.ToString("F1")% margin
                                    </div>
                                </div>
                            </div>
                        }
                    }
                    else
                    {
                        <div class="text-center">
                            <p class="mb-0 text-muted">No data available for visualization.</p>
                        </div>
                    }
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-lightbulb me-2"></i>Pricing Recommendations</h5>
                </div>
                <div class="card-body">
                    @if (Model.CategoryProfitability.Any())
                    {
                        var bestCategory = Model.CategoryProfitability.OrderByDescending(c => c.ROI).First();
                        var worstCategory = Model.CategoryProfitability.OrderBy(c => c.ROI).First();
                        
                        <div class="alert alert-info">
                            <h6><i class="bi bi-info-circle me-2"></i>Analysis Notes:</h6>
                            <ul class="mb-0">
                                <li>Current analysis shows <strong>40% markup</strong> across all categories</li>
                                <li>Green margins (35%+) indicate healthy profitability</li>
                                <li>Yellow margins (25-35%) suggest room for improvement</li>
                                <li>Red margins (&lt;25%) may need pricing adjustments</li>
                            </ul>
                        </div>

                        <div class="row">
                            <div class="col-12 mb-3">
                                <div class="card border-success">
                                    <div class="card-body">
                                        <h6 class="text-success">🎯 Best Opportunity: @bestCategory.Category</h6>
                                        <p class="mb-0">ROI: <strong>@bestCategory.ROI.ToString("F1")%</strong> | 
                                        Profit Potential: <strong>$@bestCategory.PotentialProfit.ToString("N0")</strong></p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-12">
                                <div class="card border-warning">
                                    <div class="card-body">
                                        <h6 class="text-warning">⚠️ Needs Attention: @worstCategory.Category</h6>
                                        <p class="mb-0">ROI: <strong>@worstCategory.ROI.ToString("F1")%</strong> | 
                                        Consider higher markup or volume discounts</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                    else
                    {
                        <div class="text-center">
                            <p class="mb-0 text-muted">No recommendations available.</p>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- Key Business Insights -->
    <div class="row">
        <div class="col-md-12">
            <div class="card border-primary">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-graph-up-arrow me-2"></i>Strategic Business Insights</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="border-start border-primary ps-3">
                                <h6 class="text-primary">Investment Analysis</h6>
                                <p class="mb-0">Total invested: <strong>$@Model.TotalCosts.ToString("N0")</strong></p>
                                <p class="mb-0">Potential return: <strong>$@Model.TotalPotentialProfit.ToString("N0")</strong></p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="border-start border-success ps-3">
                                <h6 class="text-success">Margin Strategy</h6>
                                <p class="mb-0">Overall margin: <strong>@Model.OverallMargin.ToString("F1")%</strong></p>
                                @if (Model.OverallMargin >= 30)
                                {
                                    <p class="mb-0 text-success">Healthy margin target achieved</p>
                                }
                                else
                                {
                                    <p class="mb-0 text-warning">Consider increasing markup</p>
                                }
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="border-start border-info ps-3">
                                <h6 class="text-info">Category Diversity</h6>
                                <p class="mb-0"><strong>@Model.CategoryProfitability.Count categories</strong> in portfolio</p>
                                <p class="mb-0">Diversification helps reduce risk</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="border-start border-warning ps-3">
                                <h6 class="text-warning">Next Steps</h6>
                                <p class="mb-0">Focus on high-ROI categories</p>
                                <p class="mb-0">Consider markup adjustments</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            $('[data-bs-toggle="tooltip"]').tooltip();
            
            $('.table tbody tr').each(function() {
                const margin = parseFloat($(this).find('.badge:contains("%")').first().text());
                if (margin >= 35) {
                    $(this).addClass('table-success');
                } else if (margin < 25) {
                    $(this).addClass('table-warning');
                }
            });
        });
    </script>
}
